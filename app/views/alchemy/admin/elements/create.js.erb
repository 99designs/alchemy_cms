(function() {
<%- if @element.fixed? -%>
  Alchemy.FixedElements.selectOrCreateTab('<%= @element.name %>', '<%= @element.display_name %>');
  $('#fixed_element_<%= @element.name %>')
    .append('<%= j render("add_element_button", parent_element_id: @element.id) %>');
<%- else -%>
  var $el;
  var $element_area;
  var element_html = '<%= j render("element", element: @element, draggable: true) %>';

<%- if @cutted_element_id -%>
  $('.element-editor[data-element-id="<%= @cutted_element_id %>"]').remove();
<%- end -%>

<%- if @element.parent_element -%>
  <%- if @element.parent_element.fixed? -%>
  $element_area = $('#element_<%= @element.parent_element_id %>');
  <%- else -%>
  $element_area = $('#element_<%= @element.parent_element_id %> > .nestable-elements > .nested-elements');
  <%- end -%>
<%- else -%>
  $element_area = $('#main_content_elements');
<%- end -%>

<%- if @element.lower_item -%>
  $('#element_<%= @element.lower_item.id %>').before(element_html);
<%- else -%>
  $element_area.append(element_html);
<%- end -%>

  if ($element_area.find('.element-editor').length > 0) {
    Alchemy.SortableElements(<%= @page.id %>, '<%= form_authenticity_token %>', $element_area);
  } else {
    $element_area.sortable('refresh');
  }
  Alchemy.Tinymce.init(<%= @element.richtext_contents_ids.to_json %>);
  Alchemy.PreviewWindow.refresh(function() {
    Alchemy.ElementEditors.selectElementInPreview(<%= @element.id %>);
  });

  $el = $('#element_<%= @element.id %>');
  $el.trigger('FocusElementEditor.Alchemy');
  Alchemy.GUI.initElement($el);

<%- if @clipboard.blank? -%>
  $('#clipboard_button .icon.clipboard').removeClass('full');
<%- end -%>
  <%= update_essence_select_elements(@page, @element) -%>
<%- end -%>

  Alchemy.growl('<%= _t(:successfully_added_element) %>');
  Alchemy.PreviewWindow.refresh();
  Alchemy.closeCurrentDialog();
})();
