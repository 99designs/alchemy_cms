<% rtfs = @element.contents.essence_richtexts %>

(function($) {
  var $el = $('.element_editor[data-element-id="<%= @element.id %>"]');

<% if @error %>

  $("#element_<%= @element.id -%> .spinner").replaceWith("<span class='error_icon' title='<%= @error -%>'>!</span>");

<% else %>

  $el.replaceWith('<%= escape_javascript render(:partial => "element", :object => @element) -%>');
  $el = $('#element_<%= @element.id %>');
  $('#element_area .sortable_cell').sortable('refresh');
  Alchemy.ElementEditors.reinit($el);

<% if @element.folded %>

<% if rtfs.any? %>

  Alchemy.Tinymce.removeEditor('<%= contents_form_field_ids_string(rtfs) %>');

<% end %>

<% else %>

  $el.trigger('Alchemy.SelectElementEditor');
  Alchemy.SelectBox($el);

<% if rtfs.any? %>
  Alchemy.Tinymce.addEditor('<%= contents_form_field_ids_string(rtfs) %>');
<% end %>

  Alchemy.GUI.initElement($el);

<% end %>

<% end %>
})(jQuery);
