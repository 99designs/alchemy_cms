<%- unless atom.atom.wa_image.nil? -%>
	<%- image_size = atom.atom.image_size.blank? ? options[:image_size] : atom.atom.image_size -%>
	
	<%- img_tag = image_tag(
		show_image_path(
			:id => atom.atom.wa_image.id,
			:name => atom.atom.wa_image.urlname,
			:size => image_size,
			:crop => options[:crop],
			:upsample  => options[:upsample],
			:padding => options[:padding],
			:format => (options[:format].blank? ? configuration(:image_output_format) : options[:format])
		),
		:alt => (atom.atom.alt_tag.blank? ? nil : atom.atom.alt_tag),
		:title => (atom.atom.title.blank? ? nil : atom.atom.title),
		:class => (options[:css_class].blank? ? nil : options[:css_class]),
		:id => dom_id(atom.atom.wa_image)
	) -%>
	
	<%- caption = (content_tag("div", atom.atom.caption, :id => "#{dom_id(atom.atom.wa_image)}_caption", :class => "wa_image_caption") unless (options[:show_caption] == false)) -%>

	<%- if atom.atom.link.blank? -%>
		<%= img_tag %>
		<%- unless atom.atom.caption.blank? -%>
			<%= caption %>
		<%- end -%>
	<%- else -%>
		<%= link_to(
			atom.atom.caption.blank? || options[:show_caption] == false ? img_tag : img_tag + caption,
			url_for(atom.atom.link),
			:title => atom.atom.link_title,
			:target => (atom.atom.open_link_in_new_window? ? "_blank" : "")
		) %>
	<%- end -%>

<%- end -%>