<%- has_rtf_atoms = element.contents.detect { |atom| atom.essence_type == 'EssenceRichtext' } -%>

<div class="element_editor<%= element.folded ? ' folded' : '' %>" id="element_<%= element.id %>">
	<%= render :partial => "element_head", :locals => {:element => element} %>
	<%- if !element.folded? -%>
		<% form_remote_tag(
			:url => element_path(element),
			:method => :put,
			:before => (has_rtf_atoms ? "saveRtfContents(#{element.id})" : nil),
			:loading => %(
				$('element_#{element.id}_save').hide();
				$('element_#{element.id}_spinner').show();
			),
			:complete => %(
				$('element_#{element.id}_save').show();
				$('element_#{element.id}_spinner').hide();
			),
			:html => {
				:id => "element_#{element.id}_form"
			}
		) do %>
			<div id="element_<%= element.id %>_content" class="element_content">
				<%= render_editor(element) %>
			</div>
			<%= render :partial => 'element_foot', :locals => {:element => element} %>
		<% end %>
	<%- end -%>
</div>

<script type="text/javascript" charset="utf-8">
// <![CDATA[
	$('element_<%= element.id %>').observe('alchemy:expand_element', function (e) {
		var el_ed = e.element();
		var id = e.memo.element_id;
		if (el_ed.hasClassName('folded')) {
			new Ajax.Request(
				'/elements/fold?id='+id,
				{
					request: 'post',
					onComplete: function () {
						$('element_<%= element.id %>').addClassName('selected');
					}
				}
			);
		};
		e.stop();
	});
// ]]>
</script>
<%- if has_rtf_atoms -%>
<script type="text/javascript" charset="utf-8">
// <![CDATA[
	TinymceHammer.init();
// ]]>
</script>
<%- end -%>
